<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Methodentag - Kurszuteilung</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg role='img' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill='%23FF1493' d='M10.145 20.014c-.266-.085-.267-.122-.022-.865.244-.743.132-1.432-.32-1.974-.617-.737-.914-1.366-1.009-2.135-.08-.66-.107-.713-.376-.764-.18-.035-.43.034-1.023.281-.864.36-1.07.52-1.273.98-.108.242-.12.387-.06.667.075.342.378.892.494.893.03 0 .196.114.368.252.287.23.307.27.225.458-.176.408-.595.902-.764.902-.095 0-.482-.272-.91-.637-.836-.717-.872-.79-.96-1.965-.1-1.403.244-2.058 1.78-3.375l.964-.827.062-.5c.063-.518-.026-1.748-.177-2.427-.09-.4-.382-.783-.66-.86-.303-.084-.48.09-.712.694-.25.654-.486.882-.92.882-.27 0-.52-.173-.694-.477C4.033 9 3.96 7.691 4.035 7.002c.036-.33.038-.666.005-.745-.054-.128-.52-.405-1.62-.962a4.343 4.343 0 0 1-.518-.303 3.053 3.053 0 0 0-.49-.267C.994 4.54-.095 3.903.007 3.903c.193 0 1.01.252 1.446.445.266.118.52.215.565.215.045 0 .558.165 1.14.366.58.202 1.111.367 1.18.367.16 0 .185-.14.134-.746-.024-.275-.023-.5.002-.5s.132.053.238.118c.324.198 1.02.32 1.84.32.783.002 1.806.157 2.196.335.56.254 1.211 1.05 2.036 2.49.574 1.002 1.19 1.426 2.073 1.427.357 0 1.31-.147 2.6-.4 1.063-.21 2.467-.259 3.012-.103.665.19 1.545.7 2.27 1.314.68.576.786.704 1.204 1.468.5.912 1.05 2.207 1.54 3.622.07.202.216.54.326.753.294.568.28.603-.255.603-.58 0-.853-.092-1.233-.415-.365-.31-.46-.5-1.032-2.05-.292-.796-.577-1.273-.76-1.273-.124 0-.376.852-.376 1.273 0 .3.187.702.67 1.447.788 1.21 1.202 2.922 1.036 4.28l-.07.586-.526.022c-.825.034-.817.046-.817-1.135 0-1.257-.085-1.529-.64-2.035-.23-.21-.748-.81-1.149-1.33-.402-.52-.786-.946-.854-.946-.158 0-.236.428-.244 1.332-.006.595-.03.696-.205.88-.476.497-.81 1.403-1.016 2.754-.046.3-.085.355-.279.398-.285.064-1.075.075-1.143.015-.059-.05.044-.863.278-2.19.088-.504.185-1.18.214-1.503.053-.574-.065-1.65-.204-1.867-.058-.09-.353-.11-1.732-.116-.915-.003-1.918-.033-2.23-.066l-.565-.06v.25c0 .27.07.506.53 1.822.162.464.397 1.17.523 1.57l.227.728-.192.592a6.11 6.11 0 0 1-.348.867c-.152.266-.17.274-.595.27a2.97 2.97 0 0 1-.677-.083z'/%3E%3C/svg%3E">
    
    <!-- Material Design 3 -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    
    <style>
        /* Light Mode Colors */
        :root[data-theme="light"] {
            /* Material Design 3 Color Tokens - Light */
            --md-sys-color-primary: #6750A4;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #EADDFF;
            --md-sys-color-on-primary-container: #21005D;
            
            --md-sys-color-secondary: #625B71;
            --md-sys-color-on-secondary: #FFFFFF;
            --md-sys-color-secondary-container: #E8DEF8;
            --md-sys-color-on-secondary-container: #1D192B;
            
            --md-sys-color-tertiary: #7D5260;
            --md-sys-color-on-tertiary: #FFFFFF;
            
            --md-sys-color-error: #B3261E;
            --md-sys-color-on-error: #FFFFFF;
            --md-sys-color-error-container: #F9DEDC;
            --md-sys-color-on-error-container: #410E0B;
            
            --md-sys-color-background: #FEF7FF;
            --md-sys-color-on-background: #1D1B20;
            --md-sys-color-surface: #FEF7FF;
            --md-sys-color-on-surface: #1D1B20;
            --md-sys-color-surface-variant: #E7E0EC;
            --md-sys-color-on-surface-variant: #49454F;
            --md-sys-color-outline: #79747E;
            --md-sys-color-outline-variant: #CAC4D0;
            
            --md-sys-color-surface-container: #F3EDF7;
            --md-sys-color-surface-container-high: #ECE6F0;
            --md-sys-color-surface-container-highest: #E6E0E9;
        }
        
        /* Dark Mode Colors (Default) */
        :root,
        :root[data-theme="dark"] {
            /* Material Design 3 Color Tokens - Dark */
            --md-sys-color-primary: #D0BCFF;
            --md-sys-color-on-primary: #381E72;
            --md-sys-color-primary-container: #4F378B;
            --md-sys-color-on-primary-container: #EADDFF;
            
            --md-sys-color-secondary: #CCC2DC;
            --md-sys-color-on-secondary: #332D41;
            --md-sys-color-secondary-container: #4A4458;
            --md-sys-color-on-secondary-container: #E8DEF8;
            
            --md-sys-color-tertiary: #EFB8C8;
            --md-sys-color-on-tertiary: #492532;
            
            --md-sys-color-error: #F2B8B5;
            --md-sys-color-on-error: #601410;
            --md-sys-color-error-container: #8C1D18;
            --md-sys-color-on-error-container: #F9DEDC;
            
            --md-sys-color-background: #1D1B20;
            --md-sys-color-on-background: #E6E0E9;
            --md-sys-color-surface: #1D1B20;
            --md-sys-color-on-surface: #E6E0E9;
            --md-sys-color-surface-variant: #49454F;
            --md-sys-color-on-surface-variant: #CAC4D0;
            --md-sys-color-outline: #938F99;
            --md-sys-color-outline-variant: #49454F;
            
            --md-sys-color-surface-container: #211F26;
            --md-sys-color-surface-container-high: #2B2930;
            --md-sys-color-surface-container-highest: #36343B;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            vertical-align: middle;
            margin-right: 8px;
        }
        
        /* App Bar */
        .app-bar {
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            padding: 16px 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .app-bar h1 {
            font-size: 22px;
            font-weight: 400;
            display: flex;
            align-items: center;
        }
        
        .app-bar h1 .material-symbols-outlined {
            font-size: 28px;
            margin-right: 12px;
        }
        
        /* Theme Toggle */
        .theme-toggle {
            background: none;
            border: none;
            color: var(--md-sys-color-on-surface);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        
        .theme-toggle:hover {
            background-color: var(--md-sys-color-surface-container-highest);
        }
        
        .theme-toggle .material-symbols-outlined {
            font-size: 24px;
            margin: 0;
        }
        
        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }
        
        /* Cards */
        .card {
            background-color: var(--md-sys-color-surface-container);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        }
        
        .card h2 {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 16px;
            color: var(--md-sys-color-on-surface);
            display: flex;
            align-items: center;
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 8px;
        }
        
        .text-field {
            width: 100%;
            padding: 16px;
            font-size: 16px;
            font-family: 'Roboto', sans-serif;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 4px;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            transition: border-color 0.2s;
        }
        
        .text-field:focus {
            outline: none;
            border-color: var(--md-sys-color-primary);
            border-width: 2px;
            padding: 15px;
        }
        
        /* Switch */
        .switch-container {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 32px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--md-sys-color-surface-variant);
            transition: 0.3s;
            border-radius: 16px;
            border: 2px solid var(--md-sys-color-outline);
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 6px;
            bottom: 6px;
            background-color: var(--md-sys-color-outline);
            transition: 0.3s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--md-sys-color-primary);
            border-color: var(--md-sys-color-primary);
        }
        
        input:checked + .slider:before {
            transform: translateX(20px);
            background-color: var(--md-sys-color-on-primary);
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 24px;
            font-size: 14px;
            font-weight: 500;
            font-family: 'Roboto', sans-serif;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }
        
        .btn-primary:hover:not(:disabled) {
            background-color: #7965AF;
            box-shadow: 0 2px 8px rgba(103, 80, 164, 0.3);
        }
        
        .btn-secondary {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }
        
        .btn-secondary:hover:not(:disabled) {
            background-color: #D5CAE8;
        }
        
        .btn:disabled {
            opacity: 0.38;
            cursor: not-allowed;
        }
        
        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        /* Info Box */
        .info-box {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            display: flex;
            align-items: start;
            gap: 12px;
        }
        
        .info-box .material-symbols-outlined {
            color: var(--md-sys-color-primary);
            font-size: 24px;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background-color: var(--md-sys-color-surface-container-high);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 500;
            color: var(--md-sys-color-primary);
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
        }
        
        /* Table */
        .table-container {
            overflow-x: auto;
            margin-top: 16px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }
        
        th {
            background-color: var(--md-sys-color-surface-container-highest);
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
            font-size: 14px;
        }
        
        tr:hover {
            background-color: var(--md-sys-color-surface-container);
        }
        
        /* Loading Spinner */
        .spinner {
            display: none;
            border: 3px solid var(--md-sys-color-surface-variant);
            border-top: 3px solid var(--md-sys-color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading .spinner {
            display: block;
        }
        
        /* Hidden */
        .hidden {
            display: none !important;
        }
        
        /* Course Limits Table */
        .course-limits-container {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 16px;
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: 8px;
        }
        
        .course-limits-table {
            width: 100%;
        }
        
        .course-limits-table th,
        .course-limits-table td {
            padding: 8px 12px;
        }
        
        .course-limits-table input[type="number"] {
            width: 80px;
            padding: 6px 8px;
            font-size: 14px;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 4px;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
        }
        
        .course-limits-table input[type="number"]:focus {
            outline: none;
            border-color: var(--md-sys-color-primary);
            border-width: 2px;
            padding: 5px 7px;
        }
        
        .limit-set {
            background-color: var(--md-sys-color-primary-container);
        }
        
        .limit-set input {
            border-color: var(--md-sys-color-primary);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .app-bar h1 {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <!-- App Bar -->
    <div class="app-bar">
        <h1>
            <span class="material-symbols-outlined">school</span>
            Methodentag - Kurszuteilung
        </h1>
        <button class="theme-toggle" onclick="toggleTheme()" title="Farbschema wechseln">
            <span class="material-symbols-outlined" id="themeIcon">light_mode</span>
        </button>
    </div>
    
    <!-- Main Container -->
    <div class="container">
        <!-- Info Box -->
        <div class="info-box">
            <span class="material-symbols-outlined">info</span>
            <div>
                <strong>Willkommen zur Kurszuteilung!</strong><br>
                Dieses Tool verteilt Sch√ºler automatisch auf Kurse unter Ber√ºcksichtigung ihrer W√ºnsche.
                Jeder Sch√ºler erh√§lt 3 Kurse (einen pro Zeitfenster).
                <br><br>
                üîí <strong>Datenschutz:</strong> Alle hochgeladenen Daten werden nur tempor√§r im RAM gespeichert und niemals auf der Festplatte abgelegt.
            </div>
        </div>
        
        <!-- Upload Card -->
        <div class="card">
            <h2>
                <span class="material-symbols-outlined">upload_file</span>
                1. CSV-Datei hochladen
            </h2>
            <p style="margin-bottom: 16px; color: var(--md-sys-color-on-surface-variant);">
                Laden Sie die CSV-Datei mit den Sch√ºlerdaten hoch (enth√§lt Nachname, Vorname, Klasse und W√ºnsche).
            </p>
            
            <div style="margin-bottom: 16px;">
                <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="uploadFile()">
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="document.getElementById('csvFile').click()">
                        <span class="material-symbols-outlined">folder_open</span>
                        Datei ausw√§hlen
                    </button>
                    <button class="btn btn-secondary" onclick="clearData()" id="clearBtn" style="display: none;">
                        <span class="material-symbols-outlined">delete</span>
                        Daten l√∂schen
                    </button>
                </div>
            </div>
            
            <div id="uploadStatus" class="hidden" style="margin-top: 16px;">
                <div id="uploadSuccess" class="info-box" style="display: none; background-color: var(--md-sys-color-primary-container);">
                    <span class="material-symbols-outlined" style="color: var(--md-sys-color-primary);">check_circle</span>
                    <div>
                        <strong>Datei erfolgreich hochgeladen!</strong><br>
                        <span id="uploadedFileName"></span>
                    </div>
                </div>
                <div id="uploadError" class="info-box" style="display: none; background-color: var(--md-sys-color-error-container);">
                    <span class="material-symbols-outlined" style="color: var(--md-sys-color-error);">error</span>
                    <div>
                        <strong>Fehler beim Hochladen!</strong><br>
                        <span id="uploadErrorMessage"></span>
                    </div>
                </div>
            </div>
            <div id="uploadSpinner" class="spinner"></div>
        </div>
        
        <!-- Analysis Card -->
        <div class="card">
            <h2>
                <span class="material-symbols-outlined">analytics</span>
                2. Datenanalyse
            </h2>
            <p style="margin-bottom: 16px; color: var(--md-sys-color-on-surface-variant);">
                Laden Sie die CSV-Datei und analysieren Sie die Daten.
            </p>
            <button class="btn btn-primary" onclick="analyzeData()">
                <span class="material-symbols-outlined">query_stats</span>
                Daten analysieren
            </button>
            <div id="analysisSpinner" class="spinner"></div>
            <div id="analysisResults" class="hidden" style="margin-top: 24px;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="studentCount">-</div>
                        <div class="stat-label">Sch√ºler</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="courseCount">-</div>
                        <div class="stat-label">Kurse</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Configuration Card -->
        <div class="card">
            <h2>
                <span class="material-symbols-outlined">settings</span>
                3. Konfiguration
            </h2>
            
            <div class="form-group">
                <label for="maxStudents">Maximale Anzahl Sch√ºler pro Kurs (global, optional)</label>
                <input type="number" id="maxStudents" class="text-field" 
                       placeholder="Leer lassen f√ºr keine globale Begrenzung" min="1">
                <small style="color: var(--md-sys-color-on-surface-variant); display: block; margin-top: 4px;">
                    Gilt f√ºr alle Kurse, au√üer individuell festgelegt (siehe unten)
                </small>
            </div>
            
            <div class="form-group">
                <label>Gleichm√§√üige Kursverteilung</label>
                <div class="switch-container">
                    <label class="switch">
                        <input type="checkbox" id="equalDistribution">
                        <span class="slider"></span>
                    </label>
                    <span style="color: var(--md-sys-color-on-surface-variant);">
                        Alle Kurse sollen ungef√§hr gleich viele Sch√ºler haben
                    </span>
                </div>
            </div>
            
            <div class="form-group">
                <label>Individuelle Kurslimits (optional)</label>
                <div style="margin-bottom: 8px;">
                    <button class="btn btn-secondary" onclick="toggleCourseLimits()" type="button">
                        <span class="material-symbols-outlined">tune</span>
                        <span id="toggleCourseLimitsText">Anzeigen</span>
                    </button>
                </div>
                <div id="courseLimitsContainer" class="hidden course-limits-container">
                    <table class="course-limits-table">
                        <thead>
                            <tr>
                                <th>Kurs</th>
                                <th>Max. Sch√ºler</th>
                            </tr>
                        </thead>
                        <tbody id="courseLimitsBody">
                            <!-- Wird dynamisch gef√ºllt -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Assignment Card -->
        <div class="card">
            <h2>
                <span class="material-symbols-outlined">assignment</span>
                4. Zuteilung durchf√ºhren
            </h2>
            <p style="margin-bottom: 16px; color: var(--md-sys-color-on-surface-variant);">
                Starten Sie den Zuteilungsalgorithmus mit den gew√§hlten Einstellungen.
            </p>
            <button class="btn btn-primary" onclick="runAssignment()">
                <span class="material-symbols-outlined">play_arrow</span>
                Zuteilung starten
            </button>
            <div id="assignmentSpinner" class="spinner"></div>
        </div>
        
        <!-- Results Card -->
        <div id="resultsCard" class="card hidden">
            <h2>
                <span class="material-symbols-outlined">check_circle</span>
                Ergebnisse
            </h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="fulfillmentRate">-</div>
                    <div class="stat-label">Erf√ºllungsrate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgCourseSize">-</div>
                    <div class="stat-label">√ò Kursgr√∂√üe</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="studentsWithoutWishes">-</div>
                    <div class="stat-label">Ohne Wunscherf√ºllung</div>
                </div>
            </div>
            
            <h3 style="margin-top: 24px; margin-bottom: 12px; font-size: 16px; font-weight: 500;">
                Erf√ºllte W√ºnsche nach Priorit√§t
            </h3>
            <div id="wishPriorities" class="stats-grid">
                <!-- Wird dynamisch gef√ºllt -->
            </div>
            
            <h3 style="margin-top: 24px; margin-bottom: 12px; font-size: 16px; font-weight: 500;">
                Top 10 beliebteste Kurse
            </h3>
            <div class="table-container">
                <table id="courseStatsTable">
                    <thead>
                        <tr>
                            <th>Kurs</th>
                            <th>Gesamt</th>
                            <th>Zeit 1</th>
                            <th>Zeit 2</th>
                            <th>Zeit 3</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Wird dynamisch gef√ºllt -->
                    </tbody>
                </table>
            </div>
            
            <h3 style="margin-top: 24px; margin-bottom: 12px; font-size: 16px; font-weight: 500;">
                Download
            </h3>
            <div class="btn-group">
                <a href="/api/download/zuteilung_schueler.csv" class="btn btn-secondary" download>
                    <span class="material-symbols-outlined">download</span>
                    Sch√ºler-Zuteilung (CSV)
                </a>
                <a href="/api/download/zuteilung_kurse.csv" class="btn btn-secondary" download>
                    <span class="material-symbols-outlined">download</span>
                    Kurs-√úbersicht (CSV)
                </a>
                <a href="/api/download/zusammenfassung.txt" class="btn btn-secondary" download>
                    <span class="material-symbols-outlined">download</span>
                    Zusammenfassung (TXT)
                </a>
                <a href="https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Ftse1.mm.bing.net%2Fth%2Fid%2FOIP.FR6MSp51ImOIPp6MNgJVqAHaEK%3Fpid%3DApi&f=1&ipt=d7d2a924993178b9f343b9a655e37f76458d4ea7323d81cee51ca33d1da29813&ipo=images" 
                   class="btn btn-secondary" 
                   download="nutella.jpg"
                   target="_blank"
                   style="background-color: #ff6b00; color: white; position: relative; overflow: hidden;">
                    <span class="material-symbols-outlined">image</span>
                    Nutella üç´
                </a>
            </div>
        </div>
    </div>
    
    <script>
        let coursesList = [];
        
        // Theme Management
        function initTheme() {
            // Standard ist Dark Mode
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }
        
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }
        
        function updateThemeIcon(theme) {
            const icon = document.getElementById('themeIcon');
            if (theme === 'dark') {
                icon.textContent = 'light_mode';
            } else {
                icon.textContent = 'dark_mode';
            }
        }
        
        // Init theme on page load
        initTheme();
        
        async function uploadFile() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                return;
            }
            
            const uploadSpinner = document.getElementById('uploadSpinner');
            const uploadStatus = document.getElementById('uploadStatus');
            const uploadSuccess = document.getElementById('uploadSuccess');
            const uploadError = document.getElementById('uploadError');
            
            uploadSpinner.style.display = 'block';
            uploadStatus.classList.remove('hidden');
            uploadSuccess.style.display = 'none';
            uploadError.style.display = 'none';
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('uploadedFileName').textContent = 
                        `${data.filename} (${data.studentCount} Sch√ºler, ${data.courseCount} Kurse)`;
                    uploadSuccess.style.display = 'flex';
                    document.getElementById('clearBtn').style.display = 'inline-flex';
                    
                    // Auto-analyze nach Upload
                    setTimeout(() => analyzeData(), 500);
                } else {
                    document.getElementById('uploadErrorMessage').textContent = data.error;
                    uploadError.style.display = 'flex';
                }
            } catch (error) {
                document.getElementById('uploadErrorMessage').textContent = error.message;
                uploadError.style.display = 'flex';
            } finally {
                uploadSpinner.style.display = 'none';
            }
        }
        
        async function clearData() {
            if (!confirm('M√∂chten Sie wirklich alle Daten aus dem Speicher l√∂schen?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/clear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Reset UI
                    document.getElementById('uploadStatus').classList.add('hidden');
                    document.getElementById('analysisResults').classList.add('hidden');
                    document.getElementById('resultsCard').classList.add('hidden');
                    document.getElementById('clearBtn').style.display = 'none';
                    document.getElementById('csvFile').value = '';
                    
                    alert('‚úì Daten wurden aus dem Speicher gel√∂scht');
                }
            } catch (error) {
                alert('Fehler beim L√∂schen: ' + error.message);
            }
        }
        
        async function analyzeData() {
            const spinner = document.getElementById('analysisSpinner');
            const results = document.getElementById('analysisResults');
            
            spinner.style.display = 'block';
            results.classList.add('hidden');
            
            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('studentCount').textContent = data.studentCount;
                    document.getElementById('courseCount').textContent = data.courseCount;
                    results.classList.remove('hidden');
                    
                    // Speichere Kursliste und erstelle Limits-Tabelle
                    coursesList = data.courses || [];
                    populateCourseLimitsTable();
                } else {
                    alert('Fehler: ' + data.error);
                }
            } catch (error) {
                alert('Fehler bei der Analyse: ' + error.message);
            } finally {
                spinner.style.display = 'none';
            }
        }
        
        function populateCourseLimitsTable() {
            const tbody = document.getElementById('courseLimitsBody');
            tbody.innerHTML = '';
            
            // Sortiere Kurse alphabetisch
            const sortedCourses = [...coursesList].sort((a, b) => a.name.localeCompare(b.name));
            
            sortedCourses.forEach(course => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" 
                        title="${course.name}">${course.name}</td>
                    <td>
                        <input type="number" 
                               class="course-limit-input" 
                               data-course="${course.name}" 
                               placeholder="Standard" 
                               min="1"
                               onchange="highlightLimitRow(this)">
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function highlightLimitRow(input) {
            const row = input.closest('tr');
            if (input.value.trim() !== '') {
                row.classList.add('limit-set');
            } else {
                row.classList.remove('limit-set');
            }
        }
        
        function toggleCourseLimits() {
            const container = document.getElementById('courseLimitsContainer');
            const text = document.getElementById('toggleCourseLimitsText');
            
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                text.textContent = 'Ausblenden';
            } else {
                container.classList.add('hidden');
                text.textContent = 'Anzeigen';
            }
        }
        
        function getCourseLimits() {
            const limits = {};
            const inputs = document.querySelectorAll('.course-limit-input');
            
            inputs.forEach(input => {
                const courseName = input.getAttribute('data-course');
                const value = input.value.trim();
                
                if (value !== '') {
                    limits[courseName] = parseInt(value);
                }
            });
            
            return limits;
        }
        
        async function runAssignment() {
            const spinner = document.getElementById('assignmentSpinner');
            const resultsCard = document.getElementById('resultsCard');
            
            const maxStudents = document.getElementById('maxStudents').value;
            const equalDistribution = document.getElementById('equalDistribution').checked;
            const courseLimits = getCourseLimits();
            
            spinner.style.display = 'block';
            resultsCard.classList.add('hidden');
            
            try {
                const response = await fetch('/api/assign', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        maxStudents: maxStudents,
                        equalDistribution: equalDistribution,
                        courseLimits: courseLimits
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayResults(data.stats);
                    resultsCard.classList.remove('hidden');
                    resultsCard.scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert('Fehler: ' + data.error);
                }
            } catch (error) {
                alert('Fehler bei der Zuteilung: ' + error.message);
            } finally {
                spinner.style.display = 'none';
            }
        }
        
        function displayResults(stats) {
            // Hauptstatistiken
            document.getElementById('fulfillmentRate').textContent = stats.fulfillmentRate + '%';
            document.getElementById('avgCourseSize').textContent = stats.averageCourseSize;
            document.getElementById('studentsWithoutWishes').textContent = stats.studentsWithoutWishes;
            
            // Wunschpriorit√§ten
            const wishPriorities = document.getElementById('wishPriorities');
            wishPriorities.innerHTML = '';
            
            for (let i = 1; i <= 4; i++) {
                const count = stats.wishPriorities[i] || 0;
                const div = document.createElement('div');
                div.className = 'stat-card';
                div.innerHTML = `
                    <div class="stat-value">${count}</div>
                    <div class="stat-label">${i}. Wunsch</div>
                `;
                wishPriorities.appendChild(div);
            }
            
            // Kurstabelle
            const tbody = document.getElementById('courseStatsTable').querySelector('tbody');
            tbody.innerHTML = '';
            
            stats.courseStats.forEach(course => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${course.name}</td>
                    <td><strong>${course.total}</strong></td>
                    <td>${course.timeslot1}</td>
                    <td>${course.timeslot2}</td>
                    <td>${course.timeslot3}</td>
                `;
                tbody.appendChild(tr);
            });
        }
    </script>

    <!-- Footer -->
    <footer style="background: var(--md-sys-color-surface-container-highest); color: var(--md-sys-color-on-surface); border-top: 1px solid var(--md-sys-color-outline-variant);">
        <div class="container" style="display:flex; justify-content:space-between; align-items:center; gap:12px; padding:12px 24px; flex-wrap: wrap;">
            <div style="font-size:14px; color:var(--md-sys-color-on-surface);">
                ¬© <span id="currentYear"></span> Paul Schoeneck
            </div>
            <div style="display: flex; align-items: center; gap: 16px;">
                <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/8a/Logo_Nutella.svg/500px-Logo_Nutella.svg.png" 
                         alt="Nutella Logo" 
                         style="height: 48px; border-radius: 8px; opacity: 0.9; transition: opacity 0.3s ease, transform 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.15);"
                         onmouseover="this.style.opacity='1'; this.style.transform='scale(1.15) rotate(5deg)';"
                         onmouseout="this.style.opacity='0.9'; this.style.transform='scale(1) rotate(0deg)';"
                         title="Powered by Nutella üç´">
                    <span style="font-size: 11px; color: var(--md-sys-color-on-surface-variant); font-weight: 500;">Powered by Nutella</span>
                </div>
            </div>
            <div style="font-size:14px; color:var(--md-sys-color-on-surface);">
                Support:
                <a href="mailto:paul.schoeneck@gmx.de" style="color:var(--md-sys-color-primary); text-decoration:none; margin-left:6px;">paul.schoeneck@gmx.de</a>
                <span style="margin:0 8px; color:var(--md-sys-color-on-surface-variant);">|</span>
                <a href="tel:+4915773651660" style="color:var(--md-sys-color-primary); text-decoration:none;">+49&nbsp;1577&nbsp;3651660</a>
            </div>
        </div>
    </footer>
    
    <script>
        // Auto-update year in footer
        document.getElementById('currentYear').textContent = new Date().getFullYear();
    </script>

</body>
</html>
